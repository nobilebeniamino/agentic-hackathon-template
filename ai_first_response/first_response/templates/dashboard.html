{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Emergency Chat - AI First Response" %}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 60vh;
        min-height: 400px;
    }
    
    .chat-messages {
        height: 100%;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #e9ecef;
    }
    
    .message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-user {
        text-align: right;
    }
    
    .message-ai {
        text-align: left;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message-user .message-bubble {
        background: var(--emergency-blue);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message-ai .message-bubble {
        background: white;
        color: #333;
        border: 2px solid #e9ecef;
        border-bottom-left-radius: 5px;
    }
    
    .message-emergency .message-bubble {
        background: var(--emergency-red);
        color: white;
        border-color: var(--emergency-red);
    }
    
    .message-warning .message-bubble {
        background: var(--emergency-orange);
        color: white;
        border-color: var(--emergency-orange);
    }
    
    .input-group {
        margin-top: 1rem;
    }
    
    .form-control {
        font-size: 1.1rem;
        padding: 12px 16px;
        border-radius: 25px;
        border: 2px solid #e9ecef;
    }
    
    .form-control:focus {
        border-color: var(--emergency-blue);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .btn-send {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        margin-left: 10px;
    }
    
    .emergency-numbers {
        background: #fff3cd;
        border: 2px solid #ffeaa7;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* Voice Controls Styles */
    .voice-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #e9ecef;
    }
    
    .btn-voice {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-record {
        background: var(--emergency-red);
        color: white;
    }
    
    .btn-record:hover {
        background: #dc3545;
        transform: scale(1.05);
    }
    
    .btn-record.recording {
        background: #dc3545;
        animation: pulse 1s infinite;
    }
    
    .btn-stop {
        background: #6c757d;
        color: white;
    }
    
    .btn-stop:hover {
        background: #5a6268;
        transform: scale(1.05);
    }
    
    .btn-play {
        background: var(--emergency-green);
        color: white;
    }
    
    .btn-play:hover {
        background: #198754;
        transform: scale(1.05);
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .voice-status {
        flex-grow: 1;
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .audio-player {
        display: none;
    }
    
    .loading-indicator {
        display: none;
        text-align: center;
        padding: 1rem;
    }
    
    .loading-dots {
        display: inline-block;
    }
    
    .loading-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--emergency-blue);
        margin: 0 2px;
        animation: loadingDots 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes loadingDots {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .location-status {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
{% csrf_token %}
<div class="row">
    <div class="col-12">
        <!-- Emergency Numbers Section -->
        <div class="emergency-numbers">
            <h5 class="mb-3">üö® <strong>{% trans "Emergency Numbers" %}</strong></h5>
            {% get_current_language as LANGUAGE_CODE %}
            {% if LANGUAGE_CODE == 'it' %}
                <!-- Italian Emergency Numbers -->
                <div class="row">
                    <div class="col-md-4">
                        <strong>üöë {% trans "Medical Emergency" %}:</strong> 118
                    </div>
                    <div class="col-md-4">
                        <strong>üöí {% trans "Fire Department" %}:</strong> 115
                    </div>
                    <div class="col-md-4">
                        <strong>üëÆ {% trans "Police" %}:</strong> 113
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <strong>üÜò {% trans "General Emergency" %}:</strong> 112
                    </div>
                    <div class="col-md-4">
                        <strong>‚õµ {% trans "Coast Guard" %}:</strong> 1530
                    </div>
                </div>
            {% else %}
                <!-- US Emergency Numbers -->
                <div class="row">
                    <div class="col-md-4">
                        <strong>üöë {% trans "Medical Emergency" %}:</strong> 911
                    </div>
                    <div class="col-md-4">
                        <strong>üöí {% trans "Fire Department" %}:</strong> 911
                    </div>
                    <div class="col-md-4">
                        <strong>üëÆ {% trans "Police" %}:</strong> 911
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <strong>üÜò {% trans "General Emergency" %}:</strong> 911
                    </div>
                    <div class="col-md-4">
                        <strong>‚õµ {% trans "Coast Guard" %}:</strong> 1-800-424-8802
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Location Status -->
        <div class="location-status">
            üìç <span id="location-text">{% trans "Getting your location..." %}</span>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message message-ai">
                    <div class="message-bubble">
                        üëã <strong>{% trans "Hello! I'm your AI First Response assistant." %}</strong><br>
                        {% trans "I'm here to help you with emergencies and provide safety instructions." %}<br><br>
                        <strong>{% trans "Tell me what's happening:" %}</strong><br>
                        ‚Ä¢ {% trans "Are you injured or in immediate danger?" %}<br>
                        ‚Ä¢ {% trans "Is there a natural disaster (earthquake, fire, flood)?" %}<br>
                        ‚Ä¢ {% trans "Do you need medical assistance?" %}<br><br>
                        {% trans "Type your message below and I'll help you right away." %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loading">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <p class="mt-2 mb-0">{% trans "AI is analyzing your emergency..." %}</p>
        </div>

        <!-- Input Section -->
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   id="message-input" 
                   placeholder="{% trans 'Describe your emergency situation...' %}"
                   autocomplete="off">
            <button class="btn btn-emergency btn-send" type="button" id="send-btn" onclick="sendMessage()">
                ‚û§
            </button>
        </div>
        
        <!-- Voice Controls -->
        <div class="voice-controls">
            <button class="btn btn-voice btn-record" id="record-btn" onclick="startRecording()" title="{% trans 'Start Recording' %}">
                üé§
            </button>
            <button class="btn btn-voice btn-stop" id="stop-btn" onclick="stopRecording()" style="display: none;" title="{% trans 'Stop Recording' %}">
                ‚èπÔ∏è
            </button>
            <button class="btn btn-voice btn-play" id="play-response-btn" onclick="playLastResponse()" style="display: none;" title="{% trans 'Play AI Response' %}">
                üîä
            </button>
            <div class="voice-status" id="voice-status">
                {% trans "Click the microphone to record a voice message" %}
            </div>
            <audio id="response-audio" class="audio-player" controls style="display: none;"></audio>
        </div>
        
        <!-- Quick Actions -->
        <div class="row mt-3">
            {% for category in emergency_categories %}
                <div class="col-md-6">
                    <button class="btn {{ category.css_class }} w-100 mb-2" 
                            onclick="quickMessage('{{ category.quick_message|escapejs }}')">
                        {{ category.icon }} {{ category.title }}
                    </button>
                </div>
            {% empty %}
                <!-- Fallback if no categories in database -->
                <div class="col-md-6">
                    <button class="btn btn-outline-danger w-100 mb-2" onclick="quickMessage('There was an earthquake')">
                        üè† Earthquake
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-danger w-100 mb-2" onclick="quickMessage('I need medical help')">
                        üöë Medical Emergency
                    </button>
                </div>
            {% endfor %}
        </div>

        <!-- Voice Controls Section -->

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Translation strings for JavaScript
const translations = {
    'location_acquired': "{% trans 'Location acquired' %}",
    'location_not_available': "{% trans 'Location not available - using default coordinates' %}",
    'geolocation_not_supported': "{% trans 'Geolocation not supported - using default coordinates' %}",
    'error': "{% trans 'Error' %}",
    'server_error': "{% trans 'Server Error' %}",
    'connection_error': "{% trans 'Connection Error' %}",
    {% get_current_language as LANGUAGE_CODE %}
    {% if LANGUAGE_CODE == 'it' %}
    'connection_error_message': "{% trans 'Unable to reach emergency services. Please try again or call 112 directly.' %}",
    'emergency_call_warning': "{% trans 'If this is a life-threatening emergency, call 112 immediately!' %}",
    {% else %}
    'connection_error_message': "Unable to reach emergency services. Please try again or call 911 directly.",
    'emergency_call_warning': "If this is a life-threatening emergency, call 911 immediately!",
    {% endif %}
    'instructions': "{% trans 'Instructions' %}"
};
let userLat = null;
let userLon = null;
let isProcessingMessage = false; // Flag to prevent overlapping message processing

// Get user location on page load
document.addEventListener('DOMContentLoaded', function() {
    getUserLocation();
    
    // Allow Enter key to send message
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent any default behavior
            const message = e.target.value.trim();
            if (message) {
                console.log('Enter key pressed, sending message:', message);
                sendMessage();
            } else {
                console.log('Enter key pressed but no message to send');
            }
        }
    });
});

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLat = position.coords.latitude;
                userLon = position.coords.longitude;
                document.getElementById('location-text').textContent = 
                    `${translations.location_acquired}: ${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
            },
            function(error) {
                document.getElementById('location-text').textContent = translations.location_not_available;
                userLat = 45.0703; // Default to Turin, Italy
                userLon = 7.6869;
            }
        );
    } else {
        document.getElementById('location-text').textContent = translations.geolocation_not_supported;
        userLat = 45.0703;
        userLon = 7.6869;
    }
}

function quickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

function addMessage(content, isUser = false, isEmergency = false) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;
    
    const bubbleClass = isEmergency ? 'message-emergency' : '';
    
    // Create unique ID for each message
    const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    let messageContent = `
        <div class="message-bubble ${bubbleClass}">
            ${content}
    `;
    
    // Add listen button for AI messages
    if (!isUser) {
        messageContent += `
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary listen-btn" onclick="playResponseAudio('${messageId}', this)">
                    <i class="fas fa-volume-up"></i> {% trans "Listen" %}
                </button>
                <span class="audio-status ms-2" id="status-${messageId}"></span>
            </div>
        `;
    }
    
    messageContent += `</div>`;
    messageDiv.innerHTML = messageContent;
    
    // Store the plain text content for TTS
    if (!isUser) {
        messageDiv.dataset.textContent = content.replace(/<[^>]*>/g, '').replace(/&nbsp;/g, ' ').trim();
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    console.log('sendMessage called with message:', message);
    
    if (!message) {
        console.log('No message to send, returning early');
        return;
    }
    
    if (isProcessingMessage) {
        console.log('Already processing a message, skipping');
        return;
    }
    
    isProcessingMessage = true;
    
    // Add user message to chat
    addMessage(message, true);
    input.value = '';
    
    // Show loading
    showLoading(true);
    
    try {
        console.log('Sending message:', message);
        console.log('Coordinates:', userLat, userLon);
        
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF Token:', csrfToken);
        
        const requestBody = {
            message: message,
            lat: userLat || 45.0703,
            lon: userLon || 7.6869,
            language: '{% get_current_language as CURRENT_LANG %}{{ CURRENT_LANG }}'
        };
        console.log('Request body:', requestBody);
        
        const response = await fetch('/api/first-response/emergency/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        // Hide loading
        showLoading(false);
        
        if (!response.ok) {
            console.error('HTTP Error:', response.status, response.statusText);
            addMessage(`‚ùå <strong>${translations.server_error}:</strong> ${response.status} ${response.statusText}`, false, true);
            return;
        }
        
        if (data.error) {
            console.error('API Error:', data.error);
            addMessage(`‚ùå <strong>${translations.error}:</strong> ${data.error}`, false, true);
        } else {
            // Format response based on severity
            const isEmergency = data.severity === 'CRIT' || data.severity === 'HIGH';
            const severityIcon = getSeverityIcon(data.severity);
            const categoryIcon = getCategoryIcon(data.category);
            
            let responseHtml = `${categoryIcon} <strong>${data.category}</strong> - ${severityIcon} ${data.severity}<br><br>`;
            
            if (data.instructions && data.instructions.length > 0) {
                responseHtml += `<strong>${translations.instructions}:</strong><br>`;
                data.instructions.forEach(instruction => {
                    responseHtml += `‚Ä¢ ${instruction}<br>`;
                });
            }
            
            if (isEmergency) {
                responseHtml += `<br><strong>‚ö†Ô∏è ${translations.emergency_call_warning}</strong>`;
            }
            
            addMessage(responseHtml, false, isEmergency);
        }
        
    } catch (error) {
        console.error('sendMessage error:', error);
        console.log('Error occurred in sendMessage function');
        showLoading(false);
        addMessage(`‚ùå <strong>{% trans 'Text Message Error' %}:</strong> ${error.message}`, false, true);
    } finally {
        isProcessingMessage = false;
    }
}

function getSeverityIcon(severity) {
    const icons = {
        'CRIT': 'üö®',
        'HIGH': '‚ö†Ô∏è',
        'MED': '‚ö°',
        'LOW': '‚ÑπÔ∏è',
        'INFO': '‚ÑπÔ∏è'
    };
    return icons[severity] || '‚ÑπÔ∏è';
}

function getCategoryIcon(category) {
    const icons = {
        'Earthquake': 'üè†',
        'Fire': 'üî•',
        'Medical': 'üöë',
        'Flood': 'üåä',
        'Emergency': 'üÜò',
        'Weather': 'üå©Ô∏è'
    };
    return icons[category] || 'üÜò';
}

function getCookie(name) {
    // First try to get from cookies
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // If not found in cookies, try to get from CSRF token input
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}

// Voice Recording Functions
let isRecording = false;
let mediaRecorder;
let audioChunks = [];
let lastAudioBlob = null;
let lastResponseAudio = null;

function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.start();
            isRecording = true;
            
            // Update UI
            document.getElementById('record-btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-flex';
            document.getElementById('play-response-btn').style.display = 'none';
            document.getElementById('response-audio').style.display = 'none';
            document.getElementById('voice-status').textContent = "{% trans 'Recording... Click stop when done' %}";
            
            // Handle data collection
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            // Handle recording stop
            mediaRecorder.onstop = () => {
                isRecording = false;
                lastAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                
                // Update UI
                document.getElementById('record-btn').style.display = 'inline-flex';
                document.getElementById('stop-btn').style.display = 'none';
                document.getElementById('voice-status').textContent = "{% trans 'Processing audio...' %}";
                
                // Send audio to server
                sendVoiceMessage(lastAudioBlob);
                
                // Stop all tracks to release microphone
                stream.getTracks().forEach(track => track.stop());
            };
        })
        .catch(error => {
            console.error('Error accessing microphone:', error);
            document.getElementById('voice-status').textContent = "{% trans 'Microphone access denied. Please check your browser settings.' %}";
        });
}

function stopRecording() {
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
    }
}

async function sendVoiceMessage(audioBlob) {
    if (isProcessingMessage) {
        console.log('Already processing a message, skipping voice message');
        return;
    }
    
    isProcessingMessage = true;
    
    try {
        // Show loading
        showLoading(true);
        
        // Create FormData
        const formData = new FormData();
        formData.append('audio', audioBlob, 'voice_message.webm');
        formData.append('language', '{% get_current_language as CURRENT_LANG %}{{ CURRENT_LANG }}');
        formData.append('latitude', userLat || 45.0703);
        formData.append('longitude', userLon || 7.6869);
        
        // Get CSRF token
        const csrfToken = getCookie('csrftoken');
        
        // Send to server
        const response = await fetch('/api/first-response/voice/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
            },
            body: formData
        });
        
        const data = await response.json();
        console.log('Voice response data:', data);
        
        if (data.success) {
            // Add transcribed message to chat as user message
            addMessage(`üé§ ${data.transcribed_text}`, true);
            
            // Format AI response the same way as text messages
            const severity = data.classification;
            const category = data.category;
            const isEmergency = severity === 'CRIT' || severity === 'HIGH';
            const severityIcon = getSeverityIcon(severity);
            const categoryIcon = getCategoryIcon(category);
            
            let responseHtml = `${categoryIcon} <strong>${category}</strong> - ${severityIcon} ${severity}<br><br>`;
            
            // Add instructions
            if (data.instructions) {
                responseHtml += `<strong>${translations.instructions}:</strong><br>`;
                // Handle both string and array formats
                if (typeof data.instructions === 'string') {
                    responseHtml += `‚Ä¢ ${data.instructions}<br>`;
                } else if (Array.isArray(data.instructions)) {
                    data.instructions.forEach(instruction => {
                        responseHtml += `‚Ä¢ ${instruction}<br>`;
                    });
                }
            }
            
            if (isEmergency) {
                responseHtml += `<br><strong>‚ö†Ô∏è ${translations.emergency_call_warning}</strong>`;
            }
            
            // Add AI response to chat with proper formatting
            addMessage(responseHtml, false, isEmergency);
            
            // Store audio URL for playback
            if (data.audio_url && data.tts_success) {
                console.log('Audio URL received:', data.audio_url);
                lastResponseAudio = data.audio_url;
                document.getElementById('play-response-btn').style.display = 'inline-flex';
                document.getElementById('response-audio').style.display = 'block';
                
                // Pre-load the audio
                const audio = document.getElementById('response-audio');
                audio.src = data.audio_url;
                audio.load(); // Force load
                
                document.getElementById('voice-status').textContent = "{% trans 'Voice message processed. Click speaker to hear response.' %}";
            } else {
                console.log('No audio URL in response or TTS failed');
                if (data.tts_error) {
                    console.error('TTS Error:', data.tts_error);
                    document.getElementById('voice-status').textContent = `TTS Error: ${data.tts_error}`;
                } else {
                    document.getElementById('voice-status').textContent = "{% trans 'Voice message processed successfully.' %}";
                }
            }
            
            // Show disaster feeds if available - for now just log them
            if (data.disaster_feeds) {
                console.log('Disaster feeds available:', data.disaster_feeds);
                // TODO: Implement showDisasterFeeds function if needed
            }
            
        } else {
            addMessage(`${translations.error}: ${data.error}`, false, true);
            document.getElementById('voice-status').textContent = `{% trans 'Error' %}: ${data.error}`;
        }
        
    } catch (error) {
        console.error('Voice message error:', error);
        console.log('Error occurred in sendVoiceMessage function');
        addMessage(`‚ùå <strong>{% trans 'Voice Error' %}:</strong> ${error.message}`, false, true);
        document.getElementById('voice-status').textContent = `{% trans 'Voice Error' %}: ${error.message}`;
    } finally {
        showLoading(false);
        isProcessingMessage = false;
    }
}

function playLastResponse() {
    if (lastResponseAudio) {
        console.log('Attempting to play audio:', lastResponseAudio);
        const audio = document.getElementById('response-audio');
        audio.src = lastResponseAudio;
        
        // Update status
        document.getElementById('voice-status').textContent = "{% trans 'Playing response...' %}";
        
        audio.play().then(() => {
            console.log('Audio playback started successfully');
        }).catch(error => {
            console.error('Error playing audio:', error);
            document.getElementById('voice-status').textContent = `{% trans 'Error playing audio response' %}: ${error.message}`;
            
            // Try alternative approach - open in new tab
            if (confirm("{% trans 'Audio playback failed. Open audio file in new tab?' %}")) {
                window.open(lastResponseAudio, '_blank');
            }
        });
        
        // Add event listeners for audio events
        audio.onended = () => {
            document.getElementById('voice-status').textContent = "{% trans 'Audio playback finished' %}";
        };
        
        audio.onerror = (e) => {
            console.error('Audio error event:', e);
            document.getElementById('voice-status').textContent = "{% trans 'Audio file could not be loaded' %}";
        };
    } else {
        console.log('No audio URL available');
        document.getElementById('voice-status').textContent = "{% trans 'No audio response available' %}";
    }
}

// Function to generate and play audio for any text response
async function playResponseAudio(messageId, buttonElement) {
    const statusElement = document.getElementById(`status-${messageId}`);
    const messageElement = buttonElement.closest('.message');
    const textContent = messageElement.dataset.textContent;
    
    if (!textContent) {
        statusElement.textContent = "{% trans 'No text to convert' %}";
        return;
    }
    
    try {
        // Update button state
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {% trans "Generating..." %}';
        statusElement.textContent = "{% trans 'Generating audio...' %}";
        
        // Send request to TTS endpoint
        const response = await fetch('/api/first-response/tts/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                text: textContent,
                language: '{% get_current_language as CURRENT_LANG %}{{ CURRENT_LANG }}'
            })
        });
        
        const data = await response.json();
        
        if (data.success && data.audio_url) {
            // Create and play audio
            const audio = new Audio(data.audio_url);
            
            statusElement.textContent = "{% trans 'Playing...' %}";
            
            audio.onended = () => {
                statusElement.textContent = "{% trans 'Finished' %}";
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<i class="fas fa-volume-up"></i> {% trans "Listen" %}';
            };
            
            audio.onerror = () => {
                statusElement.textContent = "{% trans 'Playback error' %}";
                buttonElement.disabled = false;
                buttonElement.innerHTML = '<i class="fas fa-volume-up"></i> {% trans "Listen" %}';
            };
            
            await audio.play();
            
        } else {
            throw new Error(data.error || 'TTS generation failed');
        }
        
    } catch (error) {
        console.error('TTS Error:', error);
        statusElement.textContent = `{% trans "Error" %}: ${error.message}`;
        buttonElement.disabled = false;
        buttonElement.innerHTML = '<i class="fas fa-volume-up"></i> {% trans "Listen" %}';
    }
}
</script>
{% endblock %}
