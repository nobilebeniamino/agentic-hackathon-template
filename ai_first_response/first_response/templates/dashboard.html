{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Emergency Chat - AI First Response" %}{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 60vh;
        min-height: 400px;
    }
    
    .chat-messages {
        height: 100%;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #e9ecef;
    }
    
    .message {
        margin-bottom: 1rem;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-user {
        text-align: right;
    }
    
    .message-ai {
        text-align: left;
    }
    
    .message-bubble {
        display: inline-block;
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
    }
    
    .message-user .message-bubble {
        background: var(--emergency-blue);
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .message-ai .message-bubble {
        background: white;
        color: #333;
        border: 2px solid #e9ecef;
        border-bottom-left-radius: 5px;
    }
    
    .message-emergency .message-bubble {
        background: var(--emergency-red);
        color: white;
        border-color: var(--emergency-red);
    }
    
    .message-warning .message-bubble {
        background: var(--emergency-orange);
        color: white;
        border-color: var(--emergency-orange);
    }
    
    .input-group {
        margin-top: 1rem;
    }
    
    .form-control {
        font-size: 1.1rem;
        padding: 12px 16px;
        border-radius: 25px;
        border: 2px solid #e9ecef;
    }
    
    .form-control:focus {
        border-color: var(--emergency-blue);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .btn-send {
        border-radius: 50%;
        width: 50px;
        height: 50px;
        margin-left: 10px;
    }
    
    .emergency-numbers {
        background: #fff3cd;
        border: 2px solid #ffeaa7;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .loading-indicator {
        display: none;
        text-align: center;
        padding: 1rem;
    }
    
    .loading-dots {
        display: inline-block;
    }
    
    .loading-dots span {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--emergency-blue);
        margin: 0 2px;
        animation: loadingDots 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes loadingDots {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    .location-status {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for JavaScript -->
{% csrf_token %}
<div class="row">
    <div class="col-12">
        <!-- Emergency Numbers Section -->
        <div class="emergency-numbers">
            <h5 class="mb-3">üö® <strong>{% trans "Emergency Numbers" %}</strong></h5>
            {% get_current_language as LANGUAGE_CODE %}
            {% if LANGUAGE_CODE == 'it' %}
                <!-- Italian Emergency Numbers -->
                <div class="row">
                    <div class="col-md-4">
                        <strong>üöë {% trans "Medical Emergency" %}:</strong> 118
                    </div>
                    <div class="col-md-4">
                        <strong>üöí {% trans "Fire Department" %}:</strong> 115
                    </div>
                    <div class="col-md-4">
                        <strong>üëÆ {% trans "Police" %}:</strong> 113
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <strong>üÜò {% trans "General Emergency" %}:</strong> 112
                    </div>
                    <div class="col-md-4">
                        <strong>‚õµ {% trans "Coast Guard" %}:</strong> 1530
                    </div>
                </div>
            {% else %}
                <!-- US Emergency Numbers -->
                <div class="row">
                    <div class="col-md-4">
                        <strong>üöë {% trans "Medical Emergency" %}:</strong> 911
                    </div>
                    <div class="col-md-4">
                        <strong>üöí {% trans "Fire Department" %}:</strong> 911
                    </div>
                    <div class="col-md-4">
                        <strong>üëÆ {% trans "Police" %}:</strong> 911
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <strong>üÜò {% trans "General Emergency" %}:</strong> 911
                    </div>
                    <div class="col-md-4">
                        <strong>‚õµ {% trans "Coast Guard" %}:</strong> 1-800-424-8802
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Location Status -->
        <div class="location-status">
            üìç <span id="location-text">{% trans "Getting your location..." %}</span>
        </div>

        <!-- Chat Interface -->
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message message-ai">
                    <div class="message-bubble">
                        üëã <strong>{% trans "Hello! I'm your AI First Response assistant." %}</strong><br>
                        {% trans "I'm here to help you with emergencies and provide safety instructions." %}<br><br>
                        <strong>{% trans "Tell me what's happening:" %}</strong><br>
                        ‚Ä¢ {% trans "Are you injured or in immediate danger?" %}<br>
                        ‚Ä¢ {% trans "Is there a natural disaster (earthquake, fire, flood)?" %}<br>
                        ‚Ä¢ {% trans "Do you need medical assistance?" %}<br><br>
                        {% trans "Type your message below and I'll help you right away." %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loading">
            <div class="loading-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <p class="mt-2 mb-0">{% trans "AI is analyzing your emergency..." %}</p>
        </div>

        <!-- Input Section -->
        <div class="input-group">
            <input type="text" 
                   class="form-control" 
                   id="message-input" 
                   placeholder="{% trans 'Describe your emergency situation...' %}"
                   autocomplete="off">
            <button class="btn btn-emergency btn-send" type="button" id="send-btn" onclick="sendMessage()">
                ‚û§
            </button>
        </div>
        
        <!-- Quick Actions -->
        <div class="row mt-3">
            {% for category in emergency_categories %}
                <div class="col-md-6">
                    <button class="btn {{ category.css_class }} w-100 mb-2" 
                            onclick="quickMessage('{{ category.quick_message|escapejs }}')">
                        {{ category.icon }} {{ category.title }}
                    </button>
                </div>
            {% empty %}
                <!-- Fallback if no categories in database -->
                <div class="col-md-6">
                    <button class="btn btn-outline-danger w-100 mb-2" onclick="quickMessage('There was an earthquake')">
                        üè† Earthquake
                    </button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-outline-danger w-100 mb-2" onclick="quickMessage('I need medical help')">
                        üöë Medical Emergency
                    </button>
                </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Translation strings for JavaScript
const translations = {
    'location_acquired': "{% trans 'Location acquired' %}",
    'location_not_available': "{% trans 'Location not available - using default coordinates' %}",
    'geolocation_not_supported': "{% trans 'Geolocation not supported - using default coordinates' %}",
    'error': "{% trans 'Error' %}",
    'server_error': "{% trans 'Server Error' %}",
    'connection_error': "{% trans 'Connection Error' %}",
    {% get_current_language as LANGUAGE_CODE %}
    {% if LANGUAGE_CODE == 'it' %}
    'connection_error_message': "{% trans 'Unable to reach emergency services. Please try again or call 112 directly.' %}",
    'emergency_call_warning': "{% trans 'If this is a life-threatening emergency, call 112 immediately!' %}",
    {% else %}
    'connection_error_message': "Unable to reach emergency services. Please try again or call 911 directly.",
    'emergency_call_warning': "If this is a life-threatening emergency, call 911 immediately!",
    {% endif %}
    'instructions': "{% trans 'Instructions' %}"
};
let userLat = null;
let userLon = null;

// Get user location on page load
document.addEventListener('DOMContentLoaded', function() {
    getUserLocation();
    
    // Allow Enter key to send message
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
});

function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLat = position.coords.latitude;
                userLon = position.coords.longitude;
                document.getElementById('location-text').textContent = 
                    `${translations.location_acquired}: ${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
            },
            function(error) {
                document.getElementById('location-text').textContent = translations.location_not_available;
                userLat = 45.0703; // Default to Turin, Italy
                userLon = 7.6869;
            }
        );
    } else {
        document.getElementById('location-text').textContent = translations.geolocation_not_supported;
        userLat = 45.0703;
        userLon = 7.6869;
    }
}

function quickMessage(message) {
    document.getElementById('message-input').value = message;
    sendMessage();
}

function addMessage(content, isUser = false, isEmergency = false) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;
    
    const bubbleClass = isEmergency ? 'message-emergency' : '';
    messageDiv.innerHTML = `
        <div class="message-bubble ${bubbleClass}">
            ${content}
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, true);
    input.value = '';
    
    // Show loading
    showLoading(true);
    
    try {
        console.log('Sending message:', message);
        console.log('Coordinates:', userLat, userLon);
        
        const csrfToken = getCookie('csrftoken');
        console.log('CSRF Token:', csrfToken);
        
        const requestBody = {
            message: message,
            lat: userLat || 45.0703,
            lon: userLon || 7.6869,
            language: '{% get_current_language as CURRENT_LANG %}{{ CURRENT_LANG }}'
        };
        console.log('Request body:', requestBody);
        
        const response = await fetch('/api/first-response/emergency/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken || '',
            },
            body: JSON.stringify(requestBody)
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        const data = await response.json();
        console.log('Response data:', data);
        
        // Hide loading
        showLoading(false);
        
        if (!response.ok) {
            console.error('HTTP Error:', response.status, response.statusText);
            addMessage(`‚ùå <strong>${translations.server_error}:</strong> ${response.status} ${response.statusText}`, false, true);
            return;
        }
        
        if (data.error) {
            console.error('API Error:', data.error);
            addMessage(`‚ùå <strong>${translations.error}:</strong> ${data.error}`, false, true);
        } else {
            // Format response based on severity
            const isEmergency = data.severity === 'CRIT' || data.severity === 'HIGH';
            const severityIcon = getSeverityIcon(data.severity);
            const categoryIcon = getCategoryIcon(data.category);
            
            let responseHtml = `${categoryIcon} <strong>${data.category}</strong> - ${severityIcon} ${data.severity}<br><br>`;
            
            if (data.instructions && data.instructions.length > 0) {
                responseHtml += `<strong>${translations.instructions}:</strong><br>`;
                data.instructions.forEach(instruction => {
                    responseHtml += `‚Ä¢ ${instruction}<br>`;
                });
            }
            
            if (isEmergency) {
                responseHtml += `<br><strong>‚ö†Ô∏è ${translations.emergency_call_warning}</strong>`;
            }
            
            addMessage(responseHtml, false, isEmergency);
        }
        
    } catch (error) {
        showLoading(false);
        addMessage(`‚ùå <strong>${translations.connection_error}:</strong> ${translations.connection_error_message}`, false, true);
    }
}

function getSeverityIcon(severity) {
    const icons = {
        'CRIT': 'üö®',
        'HIGH': '‚ö†Ô∏è',
        'MED': '‚ö°',
        'LOW': '‚ÑπÔ∏è',
        'INFO': '‚ÑπÔ∏è'
    };
    return icons[severity] || '‚ÑπÔ∏è';
}

function getCategoryIcon(category) {
    const icons = {
        'Earthquake': 'üè†',
        'Fire': 'üî•',
        'Medical': 'üöë',
        'Flood': 'üåä',
        'Emergency': 'üÜò',
        'Weather': 'üå©Ô∏è'
    };
    return icons[category] || 'üÜò';
}

function getCookie(name) {
    // First try to get from cookies
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    // If not found in cookies, try to get from CSRF token input
    if (!cookieValue && name === 'csrftoken') {
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    
    return cookieValue;
}
</script>
{% endblock %}
